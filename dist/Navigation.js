"use strict";
/*
 * MIT License
 *
 * Copyright (c) 2019 RÃ©mi Van Keisbelck
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Router = exports.RouteDef = exports.route3 = exports.route2 = exports.route1 = exports.route0 = exports.Path3 = exports.Path2 = exports.Path1 = exports.QueryParams = exports.Path0 = exports.regex = exports.int = exports.str = exports.PathElem = exports.newUrl = exports.ProgramWithNav = void 0;
const Program_1 = require("./Program");
const tea_cup_core_1 = require("tea-cup-core");
const React = __importStar(require("react"));
const react_1 = require("react");
/**
 * Program that handles navigation (routing).
 */
class ProgramWithNav extends react_1.Component {
    constructor(props) {
        super(props);
        this.ref = react_1.createRef();
        this.listener = tea_cup_core_1.nothing;
    }
    render() {
        return (React.createElement(Program_1.Program, { init: () => this.props.init(window.location), view: this.props.view, update: this.props.update, subscriptions: this.props.subscriptions, devTools: this.props.devTools, ref: this.ref }));
    }
    componentDidMount() {
        const l = () => {
            if (this.ref.current) {
                this.ref.current.dispatch(this.props.onUrlChange(window.location));
            }
        };
        this.listener = tea_cup_core_1.just(l);
        window.addEventListener('popstate', l);
    }
    componentWillUnmount() {
        if (this.listener.type === 'Just') {
            window.removeEventListener('popstate', this.listener.value);
            this.listener = tea_cup_core_1.nothing;
        }
    }
}
exports.ProgramWithNav = ProgramWithNav;
/**
 * Return a Task that will eventually change the browser location via historty.pushState,
 * and send back a Msg into the Program
 * @param url the url to navigate to
 */
function newUrl(url) {
    return new NewUrlTask(url);
}
exports.newUrl = newUrl;
class NewUrlTask extends tea_cup_core_1.Task {
    constructor(url) {
        super();
        this.url = url;
    }
    execute(callback) {
        const state = {};
        window.history.pushState(state, '', this.url);
        const popStateEvent = new PopStateEvent('popstate', { state: state });
        dispatchEvent(popStateEvent);
        callback(new tea_cup_core_1.Ok(document.location));
    }
}
// router
// ------
class PathElem {
}
exports.PathElem = PathElem;
class ConstantPathElem extends PathElem {
    constructor(s) {
        super();
        this.s = s;
    }
    mapPart(part) {
        if (part === this.s) {
            return tea_cup_core_1.just(part);
        }
        else {
            return tea_cup_core_1.nothing;
        }
    }
}
class RegexPathElem extends PathElem {
    constructor(regex, converter) {
        super();
        this.regex = regex.compile();
        this.converter = converter;
    }
    mapPart(part) {
        if (this.regex.test(part)) {
            return this.converter(part);
        }
        else {
            return tea_cup_core_1.nothing;
        }
    }
}
class IntPathElem extends RegexPathElem {
    constructor() {
        super(new RegExp('^\\d+$'), (s) => {
            try {
                const i = parseInt(s, 10);
                if (isNaN(i)) {
                    return tea_cup_core_1.nothing;
                }
                else {
                    return tea_cup_core_1.just(i);
                }
            }
            catch (e) {
                return tea_cup_core_1.nothing;
            }
        });
    }
}
IntPathElem.INSTANCE = new IntPathElem();
class StrPathElem extends PathElem {
    mapPart(part) {
        return tea_cup_core_1.just(part);
    }
}
function str(s) {
    if (s === undefined) {
        return new StrPathElem();
    }
    else {
        return new ConstantPathElem(s);
    }
}
exports.str = str;
function int() {
    return IntPathElem.INSTANCE;
}
exports.int = int;
function regex(r, converter) {
    return new RegexPathElem(r, converter);
}
exports.regex = regex;
class Path0 {
    map(f) {
        return new RouteDef([], f);
    }
}
exports.Path0 = Path0;
class QueryParams {
    constructor(store, hash) {
        this.store = store;
        this.hash = hash;
    }
    getValues(name) {
        return tea_cup_core_1.maybeOf(this.store[name]);
    }
    getValue(name) {
        const values = this.store[name];
        if (values === undefined) {
            return tea_cup_core_1.nothing;
        }
        else {
            return tea_cup_core_1.List.fromArray(values).head();
        }
    }
    getHash() {
        return this.hash;
    }
    static empty() {
        return new QueryParams({}, tea_cup_core_1.nothing);
    }
    static fromQueryStringAndHash(queryString, hash) {
        const params = queryString === undefined ? [] : queryString.split('&');
        const store = {};
        function addToStore(name, value) {
            let values = store[name];
            if (values === undefined) {
                values = [value];
                store[name] = values;
            }
            else {
                values.push(value);
            }
        }
        params.forEach((param) => {
            const parts = param.split('=');
            if (parts.length === 1) {
                addToStore(parts[0], '');
            }
            else if (parts.length > 1) {
                addToStore(parts[0], parts[1]);
            }
        });
        return new QueryParams(store, hash === '' ? tea_cup_core_1.nothing : tea_cup_core_1.maybeOf(hash).map((h) => (h.startsWith('#') ? h.substring(1) : h)));
    }
}
exports.QueryParams = QueryParams;
class Path1 {
    constructor(e) {
        this.e = e;
    }
    map(f) {
        return new RouteDef([this.e], f);
    }
}
exports.Path1 = Path1;
class Path2 {
    constructor(e1, e2) {
        this.e1 = e1;
        this.e2 = e2;
    }
    map(f) {
        return new RouteDef([this.e1, this.e2], f);
    }
}
exports.Path2 = Path2;
class Path3 {
    constructor(e1, e2, e3) {
        this.e1 = e1;
        this.e2 = e2;
        this.e3 = e3;
    }
    map(f) {
        return new RouteDef([this.e1, this.e2, this.e3], f);
    }
}
exports.Path3 = Path3;
exports.route0 = new Path0();
function route1(e) {
    return new Path1(e);
}
exports.route1 = route1;
function route2(e1, e2) {
    return new Path2(e1, e2);
}
exports.route2 = route2;
function route3(e1, e2, e3) {
    return new Path3(e1, e2, e3);
}
exports.route3 = route3;
class RouteDef {
    constructor(pathElems, f) {
        this.pathElems = pathElems;
        this.f = f;
    }
    static sanitizePath(path) {
        const p1 = path.startsWith('/') ? path.substring(1) : path;
        return p1.endsWith('/') ? p1.substring(0, p1.length - 1) : p1;
    }
    static splitPath(path) {
        const p = RouteDef.sanitizePath(path);
        return p === '' ? [] : p.split('/').map(decodeURIComponent);
    }
    checkRoute(pathname, query) {
        // extract path parts from location and split
        const parts = RouteDef.splitPath(pathname);
        if (parts.length === this.pathElems.length) {
            // map every individual part, bail out if
            // something cannot be converted
            const mappedParts = [];
            for (let i = 0; i < parts.length; i++) {
                const part = parts[i];
                const pe = this.pathElems[i];
                const mapped = pe.mapPart(part);
                switch (mapped.type) {
                    case 'Just':
                        mappedParts.push(mapped.value);
                        break;
                    case 'Nothing':
                        return tea_cup_core_1.nothing;
                }
            }
            // append query params to args
            mappedParts.push(query);
            // now we have mapped args, let's call the route's func
            return tea_cup_core_1.just(this.f.apply({}, mappedParts));
        }
        else {
            return tea_cup_core_1.nothing;
        }
    }
}
exports.RouteDef = RouteDef;
class Router {
    constructor(...routeDefs) {
        this.routes = routeDefs;
    }
    parse(pathname, query) {
        // try all routes one after the other
        for (let i = 0; i < this.routes.length; i++) {
            const d = this.routes[i];
            const r = d.checkRoute(pathname, query);
            if (r.type === 'Just') {
                return r;
            }
        }
        return tea_cup_core_1.nothing;
    }
    parseLocation(location) {
        return this.parse(location.pathname, QueryParams.fromQueryStringAndHash(location.search, location.hash));
    }
}
exports.Router = Router;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTmF2aWdhdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9UZWFDdXAvTmF2aWdhdGlvbi50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQXVCRzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVILHVDQUFvQztBQUNwQywrQ0FBMkc7QUFDM0csNkNBQStCO0FBQy9CLGlDQUFtRTtBQWVuRTs7R0FFRztBQUNILE1BQWEsY0FBMkIsU0FBUSxpQkFBc0M7SUFJcEYsWUFBWSxLQUFxQztRQUMvQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFIRSxRQUFHLEdBQW1DLGlCQUFTLEVBQUUsQ0FBQztRQUlqRSxJQUFJLENBQUMsUUFBUSxHQUFHLHNCQUFPLENBQUM7SUFDMUIsQ0FBQztJQUVELE1BQU07UUFDSixPQUFPLENBQ0wsb0JBQUMsaUJBQU8sSUFDTixJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxFQUM1QyxJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQ3JCLE1BQU0sRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFDekIsYUFBYSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxFQUN2QyxRQUFRLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQzdCLEdBQUcsRUFBRSxJQUFJLENBQUMsR0FBRyxHQUNiLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFFRCxpQkFBaUI7UUFDZixNQUFNLENBQUMsR0FBRyxHQUFHLEVBQUU7WUFDYixJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFO2dCQUNwQixJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLFFB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RTtnQkFDckIsT0FBTyxDQUFDLENBQUM7YUFDVjtTQUNGO1FBQ0QsT0FBTyxzQkFBTyxDQUFDO0lBQ2pCLENBQUM7SUFFRCxhQUFhLENBQUMsUUFBa0I7UUFDOUIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsV0FBVyxDQUFDLHNCQUFzQixDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDM0csQ0FBQztDQUNGO0FBdEJELHdCQXNCQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNSVQgTGljZW5zZVxuICpcbiAqIENvcHlyaWdodCAoYykgMjAxOSBSw6ltaSBWYW4gS2Vpc2JlbGNrXG4gKlxuICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4gKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuICpcbiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluIGFsbFxuICogY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbiAqXG4gKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4gKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFXG4gKiBTT0ZUV0FSRS5cbiAqXG4gKi9cblxuaW1wb3J0IHsgUHJvZ3JhbSB9IGZyb20gJy4vUHJvZ3JhbSc7XG5pbXBvcnQgeyBMaXN0LCBDbWQsIERpc3BhdGNoZXIsIFN1YiwgVGFzaywgT2ssIFJlc3VsdCwganVzdCwgTWF5YmUsIG1heWJlT2YsIG5vdGhpbmcgfSBmcm9tICd0ZWEtY3VwLWNvcmUnO1xuaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgQ29tcG9uZW50LCBjcmVhdGVSZWYsIFJlYWN0Tm9kZSwgUmVmT2JqZWN0IH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgRGV2VG9vbHMgfSBmcm9tICcuL0RldlRvb2xzJztcblxuLyoqXG4gKiBQcm9wcyBmb3IgdGhlIFByb2dyYW1XaXRoTmF2LlxuICovXG5leHBvcnQgaW50ZXJmYWNlIE5hdlByb3BzPE1vZGVsLCBNc2c+IHtcbiAgcmVhZG9ubHkgb25VcmxDaGFuZ2U6IChsOiBMb2NhdGlvbikgPT4gTXNnO1xuICByZWFkb25seSBpbml0OiAobDogTG9jYXRpb24pID0+IFtNb2RlbCwgQ21kPE1zZz5dO1xuICByZWFkb25seSB2aWV3OiAoZGlzcGF0Y2g6IERpc3BhdGNoZXI8TXNnPiwgbTogTW9kZWwpID0+IFJlYWN0Tm9kZTtcbiAgcmVhZG9ubHkgdXBkYXRlOiAobXNnOiBNc2csIG1vZGVsOiBNb2RlbCkgPT4gW01vZGVsLCBDbWQ8TXNnPl07XG4gIHJlYWRvbmx5IHN1YnNjcmlwdGlvbnM6IChtb2RlbDogTW9kZWwpID0+IFN1YjxNc2c+O1xuICByZWFkb25seSBkZXZUb29scz86IERldlRvb2xzPE1vZGVsLCBNc2c+O1xufVxuXG4vKipcbiAqIFByb2dyYW0gdGhhdCBoYW5kbGVzIG5hdmlnYXRpb24gKHJvdXRpbmcpLlxuICovXG5leHBvcnQgY2xhc3MgUHJvZ3JhbVdpdGhOYXY8TW9kZWwsIE1zZz4gZXh0ZW5kcyBDb21wb25lbnQ8TmF2UHJvcHM8TW9kZWwsIE1zZz4sIG5ldmVyPiB7XG4gIHByaXZhdGUgbGlzdGVuZXI6IE1heWJlPEV2ZW50TGlzdGVuZXI+O1xuICBwcml2YXRlIHJlYWRvbmx5IHJlZjogUmVmT2JqZWN0PFByb2dyYW08TW9kZWwsIE1zZz4+ID0gY3JlYXRlUmVmKCk7XG5cbiAgY29uc3RydWN0b3IocHJvcHM6IFJlYWRvbmx5PE5hdlByb3BzPE1vZGVsLCBNc2c+Pikge1xuICAgIHN1cGVyKHByb3BzKTtcbiAgICB0aGlzLmxpc3RlbmVyID0gbm90aGluZztcbiAgfVxuXG4gIHJlbmRlcigpOiBSZWFjdC5SZWFjdE5vZGUge1xuICAgIHJldHVybiAoXG4gICAgICA8UHJvZ3JhbVxuICAgICAgICBpbml0PXsoKSA9PiB0aGlzLnByb3BzLmluaXQod2luZG93LmxvY2F0aW9uKX1cbiAgICAgICAgdmlldz17dGhpcy5wcm9wcy52aWV3fVxuICAgICAgICB1cGRhdGU9e3RoaXMucHJvcHMudXBkYXRlfVxuICAgICAgICBzdWJzY3JpcHRpb25zPXt0aGlzLnByb3BzLnN1YnNjcmlwdGlvbnN9XG4gICAgICAgIGRldlRvb2xzPXt0aGlzLnByb3BzLmRldlRvb2xzfVxuICAgICAgICByZWY9e3RoaXMucmVmfVxuICAgICAgLz5cbiAgICApO1xuICB9XG5cbiAgY29tcG9uZW50RGlkTW91bnQoKTogdm9pZCB7XG4gICAgY29uc3QgbCA9ICgpID0+IHtcbiAgICAgIGlmICh0aGlzLnJlZi5jdXJyZW50KSB7XG4gICAgICAgIHRoaXMucmVmLmN1cnJlbnQuZGlzcGF0Y2godGhpcy5wcm9wcy5vblVybENoYW5nZSh3aW5kb3cubG9jYXRpb24pKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMubGlzdGVuZXIgPSBqdXN0KGwpO1xuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdwb3BzdGF0ZScsIGwpO1xuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgaWYgKHRoaXMubGlzdGVuZXIudHlwZSA9PT0gJ0p1c3QnKSB7XG4gICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9wc3RhdGUnLCB0aGlzLmxpc3RlbmVyLnZhbHVlKTtcbiAgICAgIHRoaXMubGlzdGVuZXIgPSBub3RoaW5nO1xuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIFJldHVybiBhIFRhc2sgdGhhdCB3aWxsIGV2ZW50dWFsbHkgY2hhbmdlIHRoZSBicm93c2VyIGxvY2F0aW9uIHZpYSBoaXN0b3J0eS5wdXNoU3RhdGUsXG4gKiBhbmQgc2VuZCBiYWNrIGEgTXNnIGludG8gdGhlIFByb2dyYW1cbiAqIEBwYXJhbSB1cmwgdGhlIHVybCB0byBuYXZpZ2F0ZSB0b1xuICovXG5leHBvcnQgZnVuY3Rpb24gbmV3VXJsKHVybDogc3RyaW5nKTogVGFzazxuZXZlciwgTG9jYXRpb24+IHtcbiAgcmV0dXJuIG5ldyBOZXdVcmxUYXNrKHVybCk7XG59XG5cbmNsYXNzIE5ld1VybFRhc2sgZXh0ZW5kcyBUYXNrPG5ldmVyLCBMb2NhdGlvbj4ge1xuICByZWFkb25seSB1cmw6IHN0cmluZztcblxuICBjb25zdHJ1Y3Rvcih1cmw6IHN0cmluZykge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy51cmwgPSB1cmw7XG4gIH1cblxuICBleGVjdXRlKGNhbGxiYWNrOiAocjogUmVzdWx0PG5ldmVyLCBMb2NhdGlvbj4pID0+IHZvaWQpOiB2b2lkIHtcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xuICAgIHdpbmRvdy5oaXN0b3J5LnB1c2hTdGF0ZShzdGF0ZSwgJycsIHRoaXMudXJsKTtcbiAgICBjb25zdCBwb3BTdGF0ZUV2ZW50ID0gbmV3IFBvcFN0YXRlRXZlbnQoJ3BvcHN0YXRlJywgeyBzdGF0ZTogc3RhdGUgfSk7XG4gICAgZGlzcGF0Y2hFdmVudChwb3BTdGF0ZUV2ZW50KTtcbiAgICBjYWxsYmFjayhuZXcgT2soZG9jdW1lbnQubG9jYXRpb24pKTtcbiAgfVxufVxuXG4vLyByb3V0ZXJcbi8vIC0tLS0tLVxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgUGF0aEVsZW08VD4ge1xuICBhYnN0cmFjdCBtYXBQYXJ0KHBhcnQ6IHN0cmluZyk6IE1heWJlPFQ+O1xufVxuXG5jbGFzcyBDb25zdGFudFBhdGhFbGVtIGV4dGVuZHMgUGF0aEVsZW08c3RyaW5nPiB7XG4gIHJlYWRvbmx5IHM6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihzOiBzdHJpbmcpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMucyA9IHM7XG4gIH1cblxuICBtYXBQYXJ0KHBhcnQ6IHN0cmluZyk6IE1heWJlPHN0cmluZz4ge1xuICAgIGlmIChwYXJ0ID09PSB0aGlzLnMpIHtcbiAgICAgIHJldHVybiBqdXN0KHBhcnQpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbm90aGluZztcbiAgICB9XG4gIH1cbn1cblxuY2xhc3MgUmVnZXhQYXRoRWxlbTxUPiBleHRlbmRzIFBhdGhFbGVtPFQ+IHtcbiAgcHJpdmF0ZSByZWFkb25seSByZWdleDogUmVnRXhwO1xuICBwcml2YXRlIHJlYWRvbmx5IGNvbnZlcnRlcjogKHM6IHN0cmluZykgPT4gTWF5YmU8VD47XG5cbiAgY29uc3RydWN0b3IocmVnZXg6IFJlZ0V4cCwgY29udmVydGVyOiAoczogc3RyaW5nKSA9PiBNYXliZTxUPikge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5yZWdleCA9IHJlZ2V4LmNvbXBpbGUoKTtcbiAgICB0aGlzLmNvbnZlcnRlciA9IGNvbnZlcnRlcjtcbiAgfVxuXG4gIG1hcFBhcnQocGFydDogc3RyaW5nKTogTWF5YmU8VD4ge1xuICAgIGlmICh0aGlzLnJlZ2V4LnRlc3QocGFydCkpIHtcbiAgICAgIHJldHVybiB0aGlzLmNvbnZlcnRlcihwYXJ0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG5vdGhpbmc7XG4gICAgfVxuICB9XG59XG5cbmNsYXNzIEludFBhdGhFbGVtIGV4dGVuZHMgUmVnZXhQYXRoRWxlbTxudW1iZXI+IHtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgc3VwZXIobmV3IFJlZ0V4cCgnXlxcXFxkKyQnKSwgKHMpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGkgPSBwYXJzZUludChzLCAxMCk7XG4gICAgICAgIGlmIChpc05hTihpKSkge1xuICAgICAgICAgIHJldHVybiBub3RoaW5nO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBqdXN0KGkpO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHJldHVybiBub3RoaW5nO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgc3RhdGljIElOU1RBTkNFOiBJbnRQYXRoRWxlbSA9IG5ldyBJbnRQYXRoRWxlbSgpO1xufVxuXG5jbGFzcyBTdHJQYXRoRWxlbSBleHRlbmRzIFBhdGhFbGVtPHN0cmluZz4ge1xuICBtYXBQYXJ0KHBhcnQ6IHN0cmluZyk6IE1heWJlPHN0cmluZz4ge1xuICAgIHJldHVybiBqdXN0KHBhcnQpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdHIocz86IHN0cmluZyk6IFBhdGhFbGVtPHN0cmluZz4ge1xuICBpZiAocyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgcmV0dXJuIG5ldyBTdHJQYXRoRWxlbSgpO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBuZXcgQ29uc3RhbnRQYXRoRWxlbShzKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaW50KCk6IFBhdGhFbGVtPG51bWJlcj4ge1xuICByZXR1cm4gSW50UGF0aEVsZW0uSU5TVEFOQ0U7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZWdleDxUPihyOiBSZWdFeHAsIGNvbnZlcnRlcjogKHM6IHN0cmluZykgPT4gTWF5YmU8VD4pOiBQYXRoRWxlbTxUPiB7XG4gIHJldHVybiBuZXcgUmVnZXhQYXRoRWxlbShyLCBjb252ZXJ0ZXIpO1xufVxuXG5leHBvcnQgY2xhc3MgUGF0aDAge1xuICBtYXA8Uj4oZjogKHF1ZXJ5OiBRdWVyeVBhcmFtcykgPT4gUik6IFJvdXRlRGVmPFI+IHtcbiAgICByZXR1cm4gbmV3IFJvdXRlRGVmPFI+KFtdLCBmKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgUXVlcnlQYXJhbXMge1xuICBwcml2YXRlIHJlYWRvbmx5IHN0b3JlOiB7IFtpZDogc3RyaW5nXTogc3RyaW5nW10gfTtcbiAgcHJpdmF0ZSByZWFkb25seSBoYXNoOiBNYXliZTxzdHJpbmc+O1xuXG4gIHByaXZhdGUgY29uc3RydWN0b3Ioc3RvcmU6IHsgW2lkOiBzdHJpbmddOiBzdHJpbmdbXSB9LCBoYXNoOiBNYXliZTxzdHJpbmc+KSB7XG4gICAgdGhpcy5zdG9yZSA9IHN0b3JlO1xuICAgIHRoaXMuaGFzaCA9IGhhc2g7XG4gIH1cblxuICBnZXRWYWx1ZXMobmFtZTogc3RyaW5nKTogTWF5YmU8UmVhZG9ubHlBcnJheTxzdHJpbmc+PiB7XG4gICAgcmV0dXJuIG1heWJlT2YodGhpcy5zdG9yZVtuYW1lXSk7XG4gIH1cblxuICBnZXRWYWx1ZShuYW1lOiBzdHJpbmcpOiBNYXliZTxzdHJpbmc+IHtcbiAgICBjb25zdCB2YWx1ZXMgPSB0aGlzLnN0b3JlW25hbWVdO1xuICAgIGlmICh2YWx1ZXMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIG5vdGhpbmc7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBMaXN0LmZyb21BcnJheSh2YWx1ZXMpLmhlYWQoKTtcbiAgICB9XG4gIH1cblxuICBnZXRIYXNoKCk6IE1heWJlPHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLmhhc2g7XG4gIH1cblxuICBzdGF0aWMgZW1wdHkoKTogUXVlcnlQYXJhbXMge1xuICAgIHJldHVybiBuZXcgUXVlcnlQYXJhbXMoe30sIG5vdGhpbmcpO1xuICB9XG5cbiAgc3RhdGljIGZyb21RdWVyeVN0cmluZ0FuZEhhc2gocXVlcnlTdHJpbmc/OiBzdHJpbmcsIGhhc2g/OiBzdHJpbmcpOiBRdWVyeVBhcmFtcyB7XG4gICAgY29uc3QgcGFyYW1zID0gcXVlcnlTdHJpbmcgPT09IHVuZGVmaW5lZCA/IFtdIDogcXVlcnlTdHJpbmcuc3BsaXQoJyYnKTtcbiAgICBjb25zdCBzdG9yZTogeyBbaWQ6IHN0cmluZ106IHN0cmluZ1tdIH0gPSB7fTtcblxuICAgIGZ1bmN0aW9uIGFkZFRvU3RvcmUobmFtZTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKSB7XG4gICAgICBsZXQgdmFsdWVzID0gc3RvcmVbbmFtZV07XG4gICAgICBpZiAodmFsdWVzID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdmFsdWVzID0gW3ZhbHVlXTtcbiAgICAgICAgc3RvcmVbbmFtZV0gPSB2YWx1ZXM7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2YWx1ZXMucHVzaCh2YWx1ZSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcGFyYW1zLmZvckVhY2goKHBhcmFtKSA9PiB7XG4gICAgICBjb25zdCBwYXJ0cyA9IHBhcmFtLnNwbGl0KCc9Jyk7XG4gICAgICBpZiAocGFydHMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgIGFkZFRvU3RvcmUocGFydHNbMF0sICcnKTtcbiAgICAgIH0gZWxzZSBpZiAocGFydHMubGVuZ3RoID4gMSkge1xuICAgICAgICBhZGRUb1N0b3JlKHBhcnRzWzBdLCBwYXJ0c1sxXSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gbmV3IFF1ZXJ5UGFyYW1zKFxuICAgICAgc3RvcmUsXG4gICAgICBoYXNoID09PSAnJyA/IG5vdGhpbmcgOiBtYXliZU9mKGhhc2gpLm1hcCgoaCkgPT4gKGguc3RhcnRzV2l0aCgnIycpID8gaC5zdWJzdHJpbmcoMSkgOiBoKSksXG4gICAgKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgUGF0aDE8VD4ge1xuICByZWFkb25seSBlOiBQYXRoRWxlbTxUPjtcblxuICBjb25zdHJ1Y3RvcihlOiBQYXRoRWxlbTxUPikge1xuICAgIHRoaXMuZSA9IGU7XG4gIH1cblxuICBtYXA8Uj4oZjogKHQ6IFQsIHF1ZXJ5OiBRdWVyeVBhcmFtcykgPT4gUik6IFJvdXRlRGVmPFI+IHtcbiAgICByZXR1cm4gbmV3IFJvdXRlRGVmPFI+KFt0aGlzLmVdLCBmKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgUGF0aDI8VDEsIFQyPiB7XG4gIHJlYWRvbmx5IGUxOiBQYXRoRWxlbTxUMT47XG4gIHJlYWRvbmx5IGUyOiBQYXRoRWxlbTxUMj47XG5cbiAgY29uc3RydWN0b3IoZTE6IFBhdGhFbGVtPFQxPiwgZTI6IFBhdGhFbGVtPFQyPikge1xuICAgIHRoaXMuZTEgPSBlMTtcbiAgICB0aGlzLmUyID0gZTI7XG4gIH1cblxuICBtYXA8Uj4oZjogKHQxOiBUMSwgdDI6IFQyLCBxdWVyeTogUXVlcnlQYXJhbXMpID0+IFIpOiBSb3V0ZURlZjxSPiB7XG4gICAgcmV0dXJuIG5ldyBSb3V0ZURlZjxSPihbdGhpcy5lMSwgdGhpcy5lMl0sIGYpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBQYXRoMzxUMSwgVDIsIFQzPiB7XG4gIHJlYWRvbmx5IGUxOiBQYXRoRWxlbTxUMT47XG4gIHJlYWRvbmx5IGUyOiBQYXRoRWxlbTxUMj47XG4gIHJlYWRvbmx5IGUzOiBQYXRoRWxlbTxUMz47XG5cbiAgY29uc3RydWN0b3IoZTE6IFBhdGhFbGVtPFQxPiwgZTI6IFBhdGhFbGVtPFQyPiwgZTM6IFBhdGhFbGVtPFQzPikge1xuICAgIHRoaXMuZTEgPSBlMTtcbiAgICB0aGlzLmUyID0gZTI7XG4gICAgdGhpcy5lMyA9IGUzO1xuICB9XG5cbiAgbWFwPFI+KGY6ICh0MTogVDEsIHQyOiBUMiwgdDM6IFQzLCBxdWVyeTogUXVlcnlQYXJhbXMpID0+IFIpOiBSb3V0ZURlZjxSPiB7XG4gICAgcmV0dXJuIG5ldyBSb3V0ZURlZjxSPihbdGhpcy5lMSwgdGhpcy5lMiwgdGhpcy5lM10sIGYpO1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCByb3V0ZTA6IFBhdGgwID0gbmV3IFBhdGgwKCk7XG5cbmV4cG9ydCBmdW5jdGlvbiByb3V0ZTE8RT4oZTogUGF0aEVsZW08RT4pOiBQYXRoMTxFPiB7XG4gIHJldHVybiBuZXcgUGF0aDE8RT4oZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByb3V0ZTI8RTEsIEUyLCBSPihlMTogUGF0aEVsZW08RTE+LCBlMjogUGF0aEVsZW08RTI+KTogUGF0aDI8RTEsIEUyPiB7XG4gIHJldHVybiBuZXcgUGF0aDI8RTEsIEUyPihlMSwgZTIpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcm91dGUzPEUxLCBFMiwgRTMsIFI+KGUxOiBQYXRoRWxlbTxFMT4sIGUyOiBQYXRoRWxlbTxFMj4sIGUzOiBQYXRoRWxlbTxFMz4pOiBQYXRoMzxFMSwgRTIsIEUzPiB7XG4gIHJldHVybiBuZXcgUGF0aDM8RTEsIEUyLCBFMz4oZTEsIGUyLCBlMyk7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUm91dGVCYXNlPFI+IHtcbiAgY2hlY2tSb3V0ZShwYXRobmFtZTogc3RyaW5nLCBxdWVyeTogUXVlcnlQYXJhbXMpOiBNYXliZTxSPjtcbn1cblxuZXhwb3J0IGNsYXNzIFJvdXRlRGVmPFI+IGltcGxlbWVudHMgUm91dGVCYXNlPFI+IHtcbiAgcmVhZG9ubHkgcGF0aEVsZW1zOiBSZWFkb25seUFycmF5PFBhdGhFbGVtPGFueT4+O1xuICByZWFkb25seSBmOiBGdW5jdGlvbjtcblxuICBjb25zdHJ1Y3RvcihwYXRoRWxlbXM6IFJlYWRvbmx5QXJyYXk8UGF0aEVsZW08YW55Pj4sIGY6IEZ1bmN0aW9uKSB7XG4gICAgdGhpcy5wYXRoRWxlbXMgPSBwYXRoRWxlbXM7XG4gICAgdGhpcy5mID0gZjtcbiAgfVxuXG4gIHN0YXRpYyBzYW5pdGl6ZVBhdGgocGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCBwMSA9IHBhdGguc3RhcnRzV2l0aCgnLycpID8gcGF0aC5zdWJzdHJpbmcoMSkgOiBwYXRoO1xuICAgIHJldHVybiBwMS5lbmRzV2l0aCgnLycpID8gcDEuc3Vic3RyaW5nKDAsIHAxLmxlbmd0aCAtIDEpIDogcDE7XG4gIH1cblxuICBzdGF0aWMgc3BsaXRQYXRoKHBhdGg6IHN0cmluZyk6IFJlYWRvbmx5QXJyYXk8c3RyaW5nPiB7XG4gICAgY29uc3QgcCA9IFJvdXRlRGVmLnNhbml0aXplUGF0aChwYXRoKTtcbiAgICByZXR1cm4gcCA9PT0gJycgPyBbXSA6IHAuc3BsaXQoJy8nKS5tYXAoZGVjb2RlVVJJQ29tcG9uZW50KTtcbiAgfVxuXG4gIGNoZWNrUm91dGUocGF0aG5hbWU6IHN0cmluZywgcXVlcnk6IFF1ZXJ5UGFyYW1zKTogTWF5YmU8Uj4ge1xuICAgIC8vIGV4dHJhY3QgcGF0aCBwYXJ0cyBmcm9tIGxvY2F0aW9uIGFuZCBzcGxpdFxuICAgIGNvbnN0IHBhcnRzID0gUm91dGVEZWYuc3BsaXRQYXRoKHBhdGhuYW1lKTtcbiAgICBpZiAocGFydHMubGVuZ3RoID09PSB0aGlzLnBhdGhFbGVtcy5sZW5ndGgpIHtcbiAgICAgIC8vIG1hcCBldmVyeSBpbmRpdmlkdWFsIHBhcnQsIGJhaWwgb3V0IGlmXG4gICAgICAvLyBzb21ldGhpbmcgY2Fubm90IGJlIGNvbnZlcnRlZFxuICAgICAgY29uc3QgbWFwcGVkUGFydHMgPSBbXTtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3QgcGFydCA9IHBhcnRzW2ldO1xuICAgICAgICBjb25zdCBwZSA9IHRoaXMucGF0aEVsZW1zW2ldO1xuICAgICAgICBjb25zdCBtYXBwZWQgPSBwZS5tYXBQYXJ0KHBhcnQpO1xuICAgICAgICBzd2l0Y2ggKG1hcHBlZC50eXBlKSB7XG4gICAgICAgICAgY2FzZSAnSnVzdCc6XG4gICAgICAgICAgICBtYXBwZWRQYXJ0cy5wdXNoKG1hcHBlZC52YWx1ZSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdOb3RoaW5nJzpcbiAgICAgICAgICAgIHJldHVybiBub3RoaW5nO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIGFwcGVuZCBxdWVyeSBwYXJhbXMgdG8gYXJnc1xuICAgICAgbWFwcGVkUGFydHMucHVzaChxdWVyeSk7XG5cbiAgICAgIC8vIG5vdyB3ZSBoYXZlIG1hcHBlZCBhcmdzLCBsZXQncyBjYWxsIHRoZSByb3V0ZSdzIGZ1bmNcbiAgICAgIHJldHVybiBqdXN0KHRoaXMuZi5hcHBseSh7fSwgbWFwcGVkUGFydHMpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG5vdGhpbmc7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBSb3V0ZXI8Uj4ge1xuICByZWFkb25seSByb3V0ZXM6IFJlYWRvbmx5QXJyYXk8Um91dGVCYXNlPFI+PjtcblxuICBjb25zdHJ1Y3RvciguLi5yb3V0ZURlZnM6IFJvdXRlQmFzZTxSPltdKSB7XG4gICAgdGhpcy5yb3V0ZXMgPSByb3V0ZURlZnM7XG4gIH1cblxuICBwYXJzZShwYXRobmFtZTogc3RyaW5nLCBxdWVyeTogUXVlcnlQYXJhbXMpOiBNYXliZTxSPiB7XG4gICAgLy8gdHJ5IGFsbCByb3V0ZXMgb25lIGFmdGVyIHRoZSBvdGhlclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5yb3V0ZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IGQgPSB0aGlzLnJvdXRlc1tpXTtcbiAgICAgIGNvbnN0IHIgPSBkLmNoZWNrUm91dGUocGF0aG5hbWUsIHF1ZXJ5KTtcbiAgICAgIGlmIChyLnR5cGUgPT09ICdKdXN0Jykge1xuICAgICAgICByZXR1cm4gcjtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG5vdGhpbmc7XG4gIH1cblxuICBwYXJzZUxvY2F0aW9uKGxvY2F0aW9uOiBMb2NhdGlvbik6IE1heWJlPFI+IHtcbiAgICByZXR1cm4gdGhpcy5wYXJzZShsb2NhdGlvbi5wYXRobmFtZSwgUXVlcnlQYXJhbXMuZnJvbVF1ZXJ5U3RyaW5nQW5kSGFzaChsb2NhdGlvbi5zZWFyY2gsIGxvY2F0aW9uLmhhc2gpKTtcbiAgfVxufVxuIl19