"use strict";
/*
 * MIT License
 *
 * Copyright (c) 2019 Rémi Van Keisbelck
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
Object.defineProperty(exports, "__esModule", { value: true });
const Navigation_1 = require("./Navigation");
const tea_cup_core_1 = require("tea-cup-core");
function home() {
    return { type: 'home' };
}
function songs(filter = tea_cup_core_1.nothing) {
    return { type: 'songs', filter: filter };
}
function song(id, edit = false) {
    return {
        type: 'song',
        id: id,
        edit: edit,
    };
}
function settings(section) {
    return {
        type: 'settings',
        section: section,
    };
}
function withSlashes(rest) {
    return {
        type: 'with-slashes',
        rest: rest,
    };
}
function withSpaces(v) {
    return {
        type: 'with-spaces',
        v: v,
    };
}
const router = new Navigation_1.Router(Navigation_1.route1(Navigation_1.str('songs')).map((s, query) => songs(query.getValue('q'))), Navigation_1.route0.map(() => home()), Navigation_1.route3(Navigation_1.str('song'), Navigation_1.int(), Navigation_1.str('edit')).map((s, id) => song(id, true)), Navigation_1.route2(Navigation_1.str('song'), Navigation_1.int()).map((_, id) => song(id)), Navigation_1.route1(Navigation_1.str('settings')).map((_, query) => settings(query.getHash())), Navigation_1.route2(Navigation_1.str('with-spaces'), Navigation_1.str()).map((_, v) => {
    return withSpaces(v);
}), {
    checkRoute(pathname, query) {
        const parts = Navigation_1.RouteDef.splitPath(pathname);
        if (parts.length < 2) {
            return tea_cup_core_1.nothing;
        }
        if (parts[0] !== 'with' || parts[1] !== 'slashes') {
            return tea_cup_core_1.nothing;
        }
        const rest = parts.length === 2 ? tea_cup_core_1.nothing : tea_cup_core_1.just(parts.slice(2).join('/'));
        return tea_cup_core_1.just(withSlashes(rest));
    },
});
expectRoute('/', home());
expectRoute('/songs', songs(tea_cup_core_1.nothing));
expectRoute('/songs/', songs(tea_cup_core_1.nothing));
expectRoute('/song/123', song(123));
expectRoute('/song/123/edit', song(123, true));
expectRoute('/songs?q=foobar', songs(tea_cup_core_1.just('foobar')));
expectRoute('/settings', settings(tea_cup_core_1.nothing));
expectRoute('/settings#blah', settings(tea_cup_core_1.just('blah')));
expectRoute('/with/slashes', withSlashes(tea_cup_core_1.nothing));
expectRoute('/with/slashes/foo', withSlashes(tea_cup_core_1.just('foo')));
expectRoute('/with/slashes/foo/bar', withSlashes(tea_cup_core_1.just('foo/bar')));
expectRoute('/with/slashes/foo/bar/baz', withSlashes(tea_cup_core_1.just('foo/bar/baz')));
expectRoute('/with-spaces/foo%20bar', withSpaces('foo bar'));
expectRoute('/with-spaces/j%26-suis_un%2Bt%C3%A9st%3Dpourl%40Q%4089%23%20%C3%A8%20je%20suis%20f%C3%A0o%C3%A7', withSpaces('j&-suis_un+tést=pourl@Q@89# è je suis fàoç'));
expectNotFound('/foo');
expectNotFound('/songs/1');
expectNotFound('/song');
expectNotFound('/song/abc');
expectNotFound('/song/123/foo');
expectSettingRouteHash('/settings#blah', tea_cup_core_1.just('blah'));
expectSettingRouteHash('/settings', tea_cup_core_1.nothing);
expectSettingRouteHash('/settings?hello', tea_cup_core_1.nothing);
expectSettingRouteHash('/settings?hello#blah', tea_cup_core_1.just('blah'));
function locFromUrl(url) {
    const indexOfQ = url.indexOf('?');
    if (indexOfQ === -1) {
        const indexOfH = url.indexOf('#');
        if (indexOfH === -1) {
            return {
                pathname: url,
                query: Navigation_1.QueryParams.empty(),
            };
        }
        else {
            return {
                pathname: url.substring(0, indexOfH),
                query: Navigation_1.QueryParams.fromQueryStringAndHash(undefined, url.substring(indexOfH + 1)),
            };
        }
    }
    else {
        const pathname = url.substring(0, indexOfQ);
        const rest = url.substring(indexOfQ + 1);
        const indexOfH = rest.indexOf('#');
        if (indexOfH === -1) {
            return {
                pathname: pathname,
                query: Navigation_1.QueryParams.fromQueryStringAndHash(rest),
            };
        }
        else {
            const q = rest.substring(0, indexOfH);
            const h = rest.substring(indexOfH + 1);
            return {
                pathname: pathname,
                query: Navigation_1.QueryParams.fromQueryStringAndHash(q, h),
            };
        }
    }
}
function locationFromLoc(url, loc) {
    return {
        ancestorOrigins: null,
        assign(url) { },
        hash: url.includes('#') ? url.split('#')[1] : '',
        host: '',
        hostname: '',
        href: '',
        origin: '',
        pathname: loc.pathname,
        port: '',
        protocol: '',
        reload() { },
        replace(url) { },
        search: '',
    };
}
function expectRoute(url, route) {
    return test(url, () => {
        const loc = locFromUrl(url);
        expect(router.parse(loc.pathname, loc.query)).toEqual(tea_cup_core_1.just(route));
    });
}
function expectNotFound(url) {
    return test(url + ' (not found)', () => {
        const loc = locFromUrl(url);
        expect(router.parse(loc.pathname, loc.query)).toEqual(tea_cup_core_1.nothing);
    });
}
function expectSettingRouteHash(url, hash) {
    return test(url + ' (hash)', () => {
        const loc = locFromUrl(url);
        const location = locationFromLoc(url, loc);
        const route = router.parseLocation(location);
        route
            .map((r) => {
            if (r.type === 'settings') {
                return expect(r.section).toEqual(hash);
            }
            throw new Error('Not the settings route!');
        })
            .withDefaultSupply(() => {
            throw new Error('Invalid Route!');
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTmF2aWdhdGlvbi50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1RlYUN1cC9OYXZpZ2F0aW9uLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQXVCRzs7QUFFSCw2Q0FBdUc7QUFDdkcsK0NBQW9EO0FBVXBELFNBQVMsSUFBSTtJQUNYLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLENBQUM7QUFDMUIsQ0FBQztBQUVELFNBQVMsS0FBSyxDQUFDLFNBQXdCLHNCQUFPO0lBQzVDLE9BQU8sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsQ0FBQztBQUMzQyxDQUFDO0FBRUQsU0FBUyxJQUFJLENBQUMsRUFBVSxFQUFFLE9BQWdCLEtBQUs7SUFDN0MsT0FBTztRQUNMLElBQUksRUFBRSxNQUFNO1FBQ1osRUFBRSxFQUFFLEVBQUU7UUFDTixJQUFJLEVBQUUsSUFBSTtLQUNYLENBQUM7QUFDSixDQUFDO0FBRUQsU0FBUyxRQUFRLENBQUMsT0FBc0I7SUFDdEMsT0FBTztRQUNMLElBQUksRUFBRSxVQUFVO1FBQ2hCLE9BQU8sRUFBRSxPQUFPO0tBQ2pCLENBQUM7QUFDSixDQUFDO0FBRUQsU0FBUyxXQUFXLENBQUMsSUFBbUI7SUFDdEMsT0FBTztRQUNMLElBQUksRUFBRSxjQUFjO1FBQ3BCLElBQUksRUFBRSxJQUFJO0tBQ1gsQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLFVBQVUsQ0FBQyxDQUFTO0lBQzNCLE9BQU87UUFDTCxJQUFJLEVBQUUsYUFBYTtRQUNuQixDQUFDLEVBQUUsQ0FBQztLQUNMLENBQUM7QUFDSixDQUFDO0FBRUQsTUFBTSxNQUFNLEdBQW9CLElBQUksbUJBQU0sQ0FDeEMsbUJBQU0sQ0FBQyxnQkFBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBUyxFQUFFLEtBQWtCLEVBQUUs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QUMsc0JBQU8sQ0FBQyxDQUFDO0lBQ2pFLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVELFNBQVMsc0JBQXNCLENBQUMsR0FBVyxFQUFFLElBQW1CO0lBQzlELE9BQU8sSUFBSSxDQUFDLEdBQUcsR0FBRyxTQUFTLEVBQUUsR0FBRyxFQUFFO1FBQ2hDLE1BQU0sR0FBRyxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM1QixNQUFNLFFBQVEsR0FBYSxlQUFlLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3JELE1BQU0sS0FBSyxHQUFtQixNQUFNLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzdELEtBQUs7YUFDRixHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtZQUNULElBQUksQ0FBQyxDQUFDLElBQUksS0FBSyxVQUFVLEVBQUU7Z0JBQ3pCLE9BQU8sTUFBTSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDeEM7WUFDRCxNQUFNLElBQUksS0FBSyxDQUFDLHlCQUF5QixDQUFDLENBQUM7UUFDN0MsQ0FBQyxDQUFDO2FBQ0QsaUJBQWlCLENBQUMsR0FBRyxFQUFFO1lBQ3RCLE1BQU0sSUFBSSxLQUFLLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUNwQyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNSVQgTGljZW5zZVxuICpcbiAqIENvcHlyaWdodCAoYykgMjAxOSBSw6ltaSBWYW4gS2Vpc2JlbGNrXG4gKlxuICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4gKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuICpcbiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluIGFsbFxuICogY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbiAqXG4gKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4gKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFXG4gKiBTT0ZUV0FSRS5cbiAqXG4gKi9cblxuaW1wb3J0IHsgUm91dGVyLCBpbnQsIHJvdXRlMCwgcm91dGUxLCByb3V0ZTIsIHJvdXRlMywgc3RyLCBRdWVyeVBhcmFtcywgUm91dGVEZWYgfSBmcm9tICcuL05hdmlnYXRpb24nO1xuaW1wb3J0IHsganVzdCwgTWF5YmUsIG5vdGhpbmcgfSBmcm9tICd0ZWEtY3VwLWNvcmUnO1xuXG50eXBlIE15Um91dGUgPVxuICB8IHsgdHlwZTogJ2hvbWUnIH1cbiAgfCB7IHR5cGU6ICdzb25ncyc7IGZpbHRlcjogTWF5YmU8c3RyaW5nPiB9XG4gIHwgeyB0eXBlOiAnc29uZyc7IGlkOiBudW1iZXI7IGVkaXQ6IGJvb2xlYW4gfVxuICB8IHsgdHlwZTogJ3NldHRpbmdzJzsgc2VjdGlvbjogTWF5YmU8c3RyaW5nPiB9XG4gIHwgeyB0eXBlOiAnd2l0aC1zbGFzaGVzJzsgcmVzdDogTWF5YmU8c3RyaW5nPiB9XG4gIHwgeyB0eXBlOiAnd2l0aC1zcGFjZXMnOyB2OiBzdHJpbmcgfTtcblxuZnVuY3Rpb24gaG9tZSgpOiBNeVJvdXRlIHtcbiAgcmV0dXJuIHsgdHlwZTogJ2hvbWUnIH07XG59XG5cbmZ1bmN0aW9uIHNvbmdzKGZpbHRlcjogTWF5YmU8c3RyaW5nPiA9IG5vdGhpbmcpOiBNeVJvdXRlIHtcbiAgcmV0dXJuIHsgdHlwZTogJ3NvbmdzJywgZmlsdGVyOiBmaWx0ZXIgfTtcbn1cblxuZnVuY3Rpb24gc29uZyhpZDogbnVtYmVyLCBlZGl0OiBib29sZWFuID0gZmFsc2UpOiBNeVJvdXRlIHtcbiAgcmV0dXJuIHtcbiAgICB0eXBlOiAnc29uZycsXG4gICAgaWQ6IGlkLFxuICAgIGVkaXQ6IGVkaXQsXG4gIH07XG59XG5cbmZ1bmN0aW9uIHNldHRpbmdzKHNlY3Rpb246IE1heWJlPHN0cmluZz4pOiBNeVJvdXRlIHtcbiAgcmV0dXJuIHtcbiAgICB0eXBlOiAnc2V0dGluZ3MnLFxuICAgIHNlY3Rpb246IHNlY3Rpb24sXG4gIH07XG59XG5cbmZ1bmN0aW9uIHdpdGhTbGFzaGVzKHJlc3Q6IE1heWJlPHN0cmluZz4pOiBNeVJvdXRlIHtcbiAgcmV0dXJuIHtcbiAgICB0eXBlOiAnd2l0aC1zbGFzaGVzJyxcbiAgICByZXN0OiByZXN0LFxuICB9O1xufVxuXG5mdW5jdGlvbiB3aXRoU3BhY2VzKHY6IHN0cmluZyk6IE15Um91dGUge1xuICByZXR1cm4ge1xuICAgIHR5cGU6ICd3aXRoLXNwYWNlcycsXG4gICAgdjogdixcbiAgfTtcbn1cblxuY29uc3Qgcm91dGVyOiBSb3V0ZXI8TXlSb3V0ZT4gPSBuZXcgUm91dGVyKFxuICByb3V0ZTEoc3RyKCdzb25ncycpKS5tYXAoKHM6IHN0cmluZywgcXVlcnk6IFF1ZXJ5UGFyYW1zKSA9PiBzb25ncyhxdWVyeS5nZXRWYWx1ZSgncScpKSksXG4gIHJvdXRlMC5tYXAoKCkgPT4gaG9tZSgpKSxcbiAgcm91dGUzKHN0cignc29uZycpLCBpbnQoKSwgc3RyKCdlZGl0JykpLm1hcCgocywgaWQpID0+IHNvbmcoaWQsIHRydWUpKSxcbiAgcm91dGUyKHN0cignc29uZycpLCBpbnQoKSkubWFwKChfLCBpZCkgPT4gc29uZyhpZCkpLFxuICByb3V0ZTEoc3RyKCdzZXR0aW5ncycpKS5tYXAoKF86IHN0cmluZywgcXVlcnk6IFF1ZXJ5UGFyYW1zKSA9PiBzZXR0aW5ncyhxdWVyeS5nZXRIYXNoKCkpKSxcbiAgcm91dGUyKHN0cignd2l0aC1zcGFjZXMnKSwgc3RyKCkpLm1hcCgoXywgdikgPT4ge1xuICAgIHJldHVybiB3aXRoU3BhY2VzKHYpO1xuICB9KSxcbiAge1xuICAgIGNoZWNrUm91dGUocGF0aG5hbWU6IHN0cmluZywgcXVlcnk6IFF1ZXJ5UGFyYW1zKTogTWF5YmU8TXlSb3V0ZT4ge1xuICAgICAgY29uc3QgcGFydHMgPSBSb3V0ZURlZi5zcGxpdFBhdGgocGF0aG5hbWUpO1xuICAgICAgaWYgKHBhcnRzLmxlbmd0aCA8IDIpIHtcbiAgICAgICAgcmV0dXJuIG5vdGhpbmc7XG4gICAgICB9XG4gICAgICBpZiAocGFydHNbMF0gIT09ICd3aXRoJyB8fCBwYXJ0c1sxXSAhPT0gJ3NsYXNoZXMnKSB7XG4gICAgICAgIHJldHVybiBub3RoaW5nO1xuICAgICAgfVxuICAgICAgY29uc3QgcmVzdCA9IHBhcnRzLmxlbmd0aCA9PT0gMiA/IG5vdGhpbmcgOiBqdXN0KHBhcnRzLnNsaWNlKDIpLmpvaW4oJy8nKSk7XG4gICAgICByZXR1cm4ganVzdCh3aXRoU2xhc2hlcyhyZXN0KSk7XG4gICAgfSxcbiAgfSxcbik7XG5cbmV4cGVjdFJvdXRlKCcvJywgaG9tZSgpKTtcbmV4cGVjdFJvdXRlKCcvc29uZ3MnLCBzb25ncyhub3RoaW5nKSk7XG5leHBlY3RSb3V0ZSgnL3NvbmdzLycsIHNvbmdzKG5vdGhpbmcpKTtcbmV4cGVjdFJvdXRlKCcvc29uZy8xMjMnLCBzb25nKDEyMykpO1xuZXhwZWN0Um91dGUoJy9zb25nLzEyMy9lZGl0Jywgc29uZygxMjMsIHRydWUpKTtcbmV4cGVjdFJvdXRlKCcvc29uZ3M/cT1mb29iYXInLCBzb25ncyhqdXN0KCdmb29iYXInKSkpO1xuZXhwZWN0Um91dGUoJy9zZXR0aW5ncycsIHNldHRpbmdzKG5vdGhpbmcpKTtcbmV4cGVjdFJvdXRlKCcvc2V0dGluZ3MjYmxhaCcsIHNldHRpbmdzKGp1c3QoJ2JsYWgnKSkpO1xuZXhwZWN0Um91dGUoJy93aXRoL3NsYXNoZXMnLCB3aXRoU2xhc2hlcyhub3RoaW5nKSk7XG5leHBlY3RSb3V0ZSgnL3dpdGgvc2xhc2hlcy9mb28nLCB3aXRoU2xhc2hlcyhqdXN0KCdmb28nKSkpO1xuZXhwZWN0Um91dGUoJy93aXRoL3NsYXNoZXMvZm9vL2JhcicsIHdpdGhTbGFzaGVzKGp1c3QoJ2Zvby9iYXInKSkpO1xuZXhwZWN0Um91dGUoJy93aXRoL3NsYXNoZXMvZm9vL2Jhci9iYXonLCB3aXRoU2xhc2hlcyhqdXN0KCdmb28vYmFyL2JheicpKSk7XG5leHBlY3RSb3V0ZSgnL3dpdGgtc3BhY2VzL2ZvbyUyMGJhcicsIHdpdGhTcGFjZXMoJ2ZvbyBiYXInKSk7XG5leHBlY3RSb3V0ZShcbiAgJy93aXRoLXNwYWNlcy9qJTI2LXN1aXNfdW4lMkJ0JUMzJUE5c3QlM0Rwb3VybCU0MFElNDA4OSUyMyUyMCVDMyVBOCUyMGplJTIwc3VpcyUyMGYlQzMlQTBvJUMzJUE3JyxcbiAgd2l0aFNwYWNlcygnaiYtc3Vpc191bit0w6lzdD1wb3VybEBRQDg5IyDDqCBqZSBzdWlzIGbDoG/DpycpLFxuKTtcbmV4cGVjdE5vdEZvdW5kKCcvZm9vJyk7XG5leHBlY3ROb3RGb3VuZCgnL3NvbmdzLzEnKTtcbmV4cGVjdE5vdEZvdW5kKCcvc29uZycpO1xuZXhwZWN0Tm90Rm91bmQoJy9zb25nL2FiYycpO1xuZXhwZWN0Tm90Rm91bmQoJy9zb25nLzEyMy9mb28nKTtcbmV4cGVjdFNldHRpbmdSb3V0ZUhhc2goJy9zZXR0aW5ncyNibGFoJywganVzdCgnYmxhaCcpKTtcbmV4cGVjdFNldHRpbmdSb3V0ZUhhc2goJy9zZXR0aW5ncycsIG5vdGhpbmcpO1xuZXhwZWN0U2V0dGluZ1JvdXRlSGFzaCgnL3NldHRpbmdzP2hlbGxvJywgbm90aGluZyk7XG5leHBlY3RTZXR0aW5nUm91dGVIYXNoKCcvc2V0dGluZ3M/aGVsbG8jYmxhaCcsIGp1c3QoJ2JsYWgnKSk7XG5cbmludGVyZmFjZSBMb2Mge1xuICBwYXRobmFtZTogc3RyaW5nO1xuICBxdWVyeTogUXVlcnlQYXJhbXM7XG59XG5cbmZ1bmN0aW9uIGxvY0Zyb21VcmwodXJsOiBzdHJpbmcpOiBMb2Mge1xuICBjb25zdCBpbmRleE9mUSA9IHVybC5pbmRleE9mKCc/Jyk7XG4gIGlmIChpbmRleE9mUSA9PT0gLTEpIHtcbiAgICBjb25zdCBpbmRleE9mSCA9IHVybC5pbmRleE9mKCcjJyk7XG4gICAgaWYgKGluZGV4T2ZIID09PSAtMSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcGF0aG5hbWU6IHVybCxcbiAgICAgICAgcXVlcnk6IFF1ZXJ5UGFyYW1zLmVtcHR5KCksXG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBwYXRobmFtZTogdXJsLnN1YnN0cmluZygwLCBpbmRleE9mSCksXG4gICAgICAgIHF1ZXJ5OiBRdWVyeVBhcmFtcy5mcm9tUXVlcnlTdHJpbmdBbmRIYXNoKHVuZGVmaW5lZCwgdXJsLnN1YnN0cmluZyhpbmRleE9mSCArIDEpKSxcbiAgICAgIH07XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGNvbnN0IHBhdGhuYW1lID0gdXJsLnN1YnN0cmluZygwLCBpbmRleE9mUSk7XG4gICAgY29uc3QgcmVzdCA9IHVybC5zdWJzdHJpbmcoaW5kZXhPZlEgKyAxKTtcbiAgICBjb25zdCBpbmRleE9mSCA9IHJlc3QuaW5kZXhPZignIycpO1xuICAgIGlmIChpbmRleE9mSCA9PT0gLTEpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHBhdGhuYW1lOiBwYXRobmFtZSxcbiAgICAgICAgcXVlcnk6IFF1ZXJ5UGFyYW1zLmZyb21RdWVyeVN0cmluZ0FuZEhhc2gocmVzdCksXG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBxID0gcmVzdC5zdWJzdHJpbmcoMCwgaW5kZXhPZkgpO1xuICAgICAgY29uc3QgaCA9IHJlc3Quc3Vic3RyaW5nKGluZGV4T2ZIICsgMSk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBwYXRobmFtZTogcGF0aG5hbWUsXG4gICAgICAgIHF1ZXJ5OiBRdWVyeVBhcmFtcy5mcm9tUXVlcnlTdHJpbmdBbmRIYXNoKHEsIGgpLFxuICAgICAgfTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gbG9jYXRpb25Gcm9tTG9jKHVybDogc3RyaW5nLCBsb2M6IExvYyk6IExvY2F0aW9uIHtcbiAgcmV0dXJuIHtcbiAgICBhbmNlc3Rvck9yaWdpbnM6IChudWxsIGFzIHVua25vd24pIGFzIERPTVN0cmluZ0xpc3QsXG4gICAgYXNzaWduKHVybDogc3RyaW5nKTogdm9pZCB7fSxcbiAgICBoYXNoOiB1cmwuaW5jbHVkZXMoJyMnKSA/IHVybC5zcGxpdCgnIycpWzFdIDogJycsXG4gICAgaG9zdDogJycsXG4gICAgaG9zdG5hbWU6ICcnLFxuICAgIGhyZWY6ICcnLFxuICAgIG9yaWdpbjogJycsXG4gICAgcGF0aG5hbWU6IGxvYy5wYXRobmFtZSxcbiAgICBwb3J0OiAnJyxcbiAgICBwcm90b2NvbDogJycsXG4gICAgcmVsb2FkKCk6IHZvaWQge30sXG4gICAgcmVwbGFjZSh1cmw6IHN0cmluZyk6IHZvaWQge30sXG4gICAgc2VhcmNoOiAnJyxcbiAgfTtcbn1cblxuZnVuY3Rpb24gZXhwZWN0Um91dGUodXJsOiBzdHJpbmcsIHJvdXRlOiBNeVJvdXRlKSB7XG4gIHJldHVybiB0ZXN0KHVybCwgKCkgPT4ge1xuICAgIGNvbnN0IGxvYyA9IGxvY0Zyb21VcmwodXJsKTtcbiAgICBleHBlY3Qocm91dGVyLnBhcnNlKGxvYy5wYXRobmFtZSwgbG9jLnF1ZXJ5KSkudG9FcXVhbChqdXN0KHJvdXRlKSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBleHBlY3ROb3RGb3VuZCh1cmw6IHN0cmluZykge1xuICByZXR1cm4gdGVzdCh1cmwgKyAnIChub3QgZm91bmQpJywgKCkgPT4ge1xuICAgIGNvbnN0IGxvYyA9IGxvY0Zyb21VcmwodXJsKTtcbiAgICBleHBlY3Qocm91dGVyLnBhcnNlKGxvYy5wYXRobmFtZSwgbG9jLnF1ZXJ5KSkudG9FcXVhbChub3RoaW5nKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGV4cGVjdFNldHRpbmdSb3V0ZUhhc2godXJsOiBzdHJpbmcsIGhhc2g6IE1heWJlPHN0cmluZz4pIHtcbiAgcmV0dXJuIHRlc3QodXJsICsgJyAoaGFzaCknLCAoKSA9PiB7XG4gICAgY29uc3QgbG9jID0gbG9jRnJvbVVybCh1cmwpO1xuICAgIGNvbnN0IGxvY2F0aW9uOiBMb2NhdGlvbiA9IGxvY2F0aW9uRnJvbUxvYyh1cmwsIGxvYyk7XG4gICAgY29uc3Qgcm91dGU6IE1heWJlPE15Um91dGU+ID0gcm91dGVyLnBhcnNlTG9jYXRpb24obG9jYXRpb24pO1xuICAgIHJvdXRlXG4gICAgICAubWFwKChyKSA9PiB7XG4gICAgICAgIGlmIChyLnR5cGUgPT09ICdzZXR0aW5ncycpIHtcbiAgICAgICAgICByZXR1cm4gZXhwZWN0KHIuc2VjdGlvbikudG9FcXVhbChoYXNoKTtcbiAgICAgICAgfVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCB0aGUgc2V0dGluZ3Mgcm91dGUhJyk7XG4gICAgICB9KVxuICAgICAgLndpdGhEZWZhdWx0U3VwcGx5KCgpID0+IHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIFJvdXRlIScpO1xuICAgICAgfSk7XG4gIH0pO1xufVxuIl19